//Projeto - Mini Sistema de cadastro - Código// 

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <locale.h>
// usar F6 para executar o programa

enum TipoUsuario
{
    ADMIN,
    COMUM
};


// Estrutura para armazenar informações do usuário
typedef struct
{
    char nome[50];
    char email[50];
    char senha[20];
    enum TipoUsuario tipo;
} Usuario;

Usuario usuarios[10000]; // array para armazenar até 10.000 usuários

// inicialização de variáveis globais
int qntdUsuarios = 0;   // quantidade de usuários cadastrados
int usuarioLogado = -1; // -1 significa que nenhum usuário está logado, se for >=0 significa o índice do usuário logado no array de usuários

void listarUsuarios() // função para listar usuários cadastrados
{ 
    if (qntdUsuarios == 0)
    {
        printf("No users registered!\n");
        return;
    }
    for (int i = 0; i < qntdUsuarios; i++)
    {
        const char *nivel = usuarios[i].tipo == ADMIN ? "ADMIN" : "COMUM"; // operador ternário - define o nível do usuário - substitui o if/else
        printf("| %-4d | %-20s | %-25s | %-8s |\n", i, usuarios[i].nome, usuarios[i].email, nivel);
    }
    printf("-------------------------------------------------------------------\n");
}

// Função de persistência de dados binária - Salvar usuários 
void salvarUsuario(){ 
    FILE *arq = fopen ("usuarios.dat", "wb"); // wb = write binary 

    if (arq == NULL){ 
        printf("Não foi possível salvar o arquivo de dados.\n"); 
        return; 
    }

    fwrite(&qntdUsuarios, sizeof(int), 1 , arq); // escreve a quantidade total de usuários no arquivo

    fwrite(usuarios, sizeof(Usuario), qntdUsuarios, arq); // escreve o array inteiro com todos os usuários 

    fclose(arq);
    printf("Dados salvos com sucesso!\n");
}


// função de persistência de dados binária - Carregar usuários 
void carregarUsuarios(){ 
    FILE *arq = fopen ("usuarios.dat", "rb"); // rb = read binary 

    if (arq == NULL){ 
        printf("Arquivo de dados não encontrado. Iniciando com nenhum usuário cadastrado.\n"); 
        return; 
    }

    fread(&qntdUsuarios, sizeof(int), 1 , arq); // lê a quantidade total de usuários do arquivo

    fread(usuarios, sizeof(Usuario), qntdUsuarios, arq); // lê o array inteiro com todos os usuários 

    fclose(arq);
    printf("Dados carregados com sucesso! %d usuários carregados.\n", qntdUsuarios);

}


int main(){
    setlocale(LC_ALL,"Portuguese");

    carregarUsuarios(); // chama a função de carragar usuários 

    

    // Escolha de opções fornecidas

    int escolhaUser;

    // Variáveis para login
    char emailLogin[50];
    char senhaLogin[20];

    do {  

    printf("\nUser Registration System\n");

    printf("\n\t1 - Register User ");
    printf("\n\t2 - Login");
    printf("\n\t3 - List users (administrators only)");
    printf("\n\t4 - Exit\n");
    printf("\n\t-> ");
    scanf("%i", &escolhaUser);
    getchar(); // sempre limpar o buffer quando vou usar fgets depois do scanf

    switch (escolhaUser)
    {

    case 1:
    {
        // Código para cadastrar usuário
        if (qntdUsuarios < 10000)
        {
            printf("Register User\n");

            printf("\tName: ");
            fgets(usuarios[qntdUsuarios].nome, 50, stdin);
            usuarios[qntdUsuarios].nome[strcspn(usuarios[qntdUsuarios].nome, "\n")] = '\0';

            printf("\tEmail: ");
            fgets(usuarios[qntdUsuarios].email, 50, stdin);
            usuarios[qntdUsuarios].email[strcspn(usuarios[qntdUsuarios].email, "\n")] = '\0';

            printf("\tPassword: ");
            fgets(usuarios[qntdUsuarios].senha, 20, stdin);
            usuarios[qntdUsuarios].senha[strcspn(usuarios[qntdUsuarios].senha, "\n")] = '\0';

            
            if (qntdUsuarios == 0){ 
                usuarios[qntdUsuarios].tipo = ADMIN; 
                printf("\tUser registered as ADMIN !\n");
            }else{ 
                usuarios[qntdUsuarios].tipo = COMUM; 
                printf("\tUser registered as COMUM !\n");
            }
            
            qntdUsuarios++;
           
        }
        else
        {
            printf("User limit reached!\n");
        }
        
        salvarUsuario(); // chama a função de salvar usuários 
        break;
    }

    case 2:
    {
        // Código para Login do usuário
        if (usuarioLogado != -1)
        {
            printf("A user is already logged in! Logging user out... \n"); // LogOut
            usuarioLogado = -1;
        }
        else
        {
            printf("User Login\n");

            printf("\tEmail: ");
            fgets(emailLogin, 50, stdin);
            emailLogin[strcspn(emailLogin, "\n")] = '\0';

            printf("\tPassword: ");
            fgets(senhaLogin, 20, stdin);
            senhaLogin[strcspn(senhaLogin, "\n")] = '\0';

            int encontrado = 0;

            for (int i = 0; i < qntdUsuarios; i++)
            {
                // verifica se o email e senha correspondem
                if (strcmp(usuarios[i].email, emailLogin) == 0 && strcmp(usuarios[i].senha, senhaLogin) == 0)
                {

                    usuarioLogado = i; // variável para armazenar o índice/posição do usuário sem depender do "int i";
                    encontrado = 1;
                    break; // sair do loop
                }
            }
            if (encontrado == 1)
            {
                printf("\tLogin successful! Welcome!, %s\n", usuarios[usuarioLogado].nome);
            }
            else
            {
                printf("\tIncorrect email or password\n");
            }
        }

        break;
    }

    case 3:
    {
        // Código para listar usuário
        printf("\n--- List of Users ---\n");

        if (usuarioLogado == -1)
        {
            printf("You need to be logged in to list users! ");
            break;
        }
        if (usuarios[usuarioLogado].tipo == ADMIN)
        {
            // Se for administrador, chama a função de listar usuários
            listarUsuarios();
        }
        else
        {
            printf("Access denied! Only administrators can list users.\n");
        }

        break;
    }

    case 4:
    {
        printf("\tLeaving the system...\n");
        salvarUsuario(); // chama a função de salvar usuários só para garantir que tudo será salvo antes de sair 
        exit(0); 
        
        break;
    }
    }
    
    } while (escolhaUser != 4); 
    
    return 0;
}
